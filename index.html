const connectButton = document.getElementById("requestPortButton");
const status = document.getElementById("status");
const page1 = document.getElementById("page-1");
const page2 = document.getElementById("page-2");

// Function to handle micro:bit connection
async function connectToMicrobit() {
  try {
    status.innerText = "Attempting to connect to micro:bit...";
    console.log("Attempting to connect to micro:bit...");

    // Request device with specific vendorId for micro:bit
    const device = await navigator.usb.requestDevice({
      filters: [{ vendorId: 0x0D28 }]
    });

    status.innerText = "Device found. Attempting to open connection...";
    console.log("Device found. Attempting to open connection...");

    await device.open(); // Open the device
    console.log("Device opened.");

    if (device.configuration === null) {
      status.innerText = "Selecting configuration...";
      console.log("No configuration selected, selecting one...");
      await device.selectConfiguration(1);
    }

    status.innerText = "Claiming interface for communication...";
    console.log("Attempting to claim interface 0...");
    await device.claimInterface(0); // Claim interface for communication

    console.log("Micro:bit connected successfully");
    status.innerText = "Micro:bit connected successfully!";
    alert("Micro:bit connected successfully!");

    // Hide Page 1 and show Page 2
    page1.style.display = "none";
    page2.style.display = "block";

  } catch (err) {
    console.error("Error connecting to micro:bit: ", err);
    status.innerText = `Failed to connect to micro:bit. Error: ${err.message}`;
    alert("Failed to connect to micro:bit. Please check console for more details.");
    
    // Offer a retry button to the user
    if (confirm("Failed to connect to micro:bit. Would you like to retry?")) {
      connectToMicrobit(); // Retry the connection process
    }
  }
}

// Attach click event to connect button
connectButton.addEventListener("click", connectToMicrobit);
