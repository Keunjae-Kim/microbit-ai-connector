<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GV15VYJMQP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }

      gtag("js", new Date());
      gtag("config", "G-GV15VYJMQP");
    </script>

    <meta charset="utf-8" />
    <title>Ai Training</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/styles/index.css" />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Karla:ital,wght@0,400;0,700;0,800;1,400&display=swap"
      rel="stylesheet"
    />

    <!-- Jquery Styles -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"
    />
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-WF39LXQ"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div id="desktop-only">
      <h2>This Application is best used with a Desktop</h2>
    </div>

    <div id="page-1">
      <!-- Page 1 content remains the same as previously provided -->
    </div>

    <div id="page-2" class="hide">
      <div>
        <span class="help-section">
          <!-- Help Section content remains the same -->
        </span>
        <span id="connectPort">
          <p class="sub-title">
            Paste your Google Teachable Machine model link here:
          </p>
          <span class="input-container">
            <input
              id="teachableUrl"
              type="url"
              placeholder="https://teachablemachine.withgoogle.com/models/[...]"
              pattern="https://.*"
              required
            />
            <span id="cam-select">
              <p>
                <label for="cam" class="choose-label">Choose Camera:</label>
                <select name="cam" id="cam"></select>
              </p>
            </span>
            <span id="aud-select">
              <p>
                <label for="aud" class="choose-label">Choose Audio:</label>
                <select name="aud" id="aud"></select>
              </p>
            </span>
            <button id="submitUrl">Ready!</button>
          </span>
        </span>
      </div>
    </div>

    <div id="page-3" class="hide">
      <div id="overlay"></div>
      <div id="reconnectModal">
        <h1>Oops!</h1>
        <h3>
          Looks like your camera is being used already or you may have denied
          access. Check and close other applications where your camera is in
          use, then click Retry when youâ€™re ready.
        </h3>
        <div onclick="initImg(true)" id="reconnectCameraButton">Retry!</div>
      </div>
      <div class="page-container">
        <div class="display">
          <div class="display-container">
            <h1 class="projectName">Loading...</h1>
            <div class="white-bck">
              <p class="description">
                This is a Recognition Project - where the AI will be able to
                identify the classes you made based on the input you give it!
              </p>
              <div id="results" class="hide-imp">
                <span class="heading">
                  <h2 id="results-heading">RESULTS!</h2>
                </span>
                <div id="label-container"></div>
              </div>
            </div>
          </div>
          <div id="webcam-container" class="webcam-container"></div>
        </div>
      </div>
    </div>

    <!-- Main Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

    <script>
      let model;
      let webcam;

      // Handling 'Ready' button click
      document.getElementById('submitUrl').addEventListener('click', async () => {
        console.log("Ready button clicked");
        const modelUrl = document.getElementById('teachableUrl').value;
        const videoSelect = document.getElementById('cam');
        const audioSelect = document.getElementById('aud');

        // Check if the required fields are filled
        if (modelUrl === '' || videoSelect.selectedIndex === -1 || audioSelect.selectedIndex === -1) {
          alert('Please fill in all fields before continuing.');
          return;
        }

        try {
          console.log("Loading Teachable Machine model...");
          // Load Teachable Machine Model
          model = await tmImage.load(modelUrl + '/model.json', modelUrl + '/metadata.json');
          console.log("Model loaded successfully");

          // Hide Page 2 and show Page 3
          document.getElementById('page-2').classList.add('hide');
          document.getElementById('page-3').classList.remove('hide');
          console.log("Navigated to Page 3");

          // Start webcam and display it on page 3
          const webcamElement = document.getElementById('webcam-container');
          webcam = new tmImage.Webcam(200, 200, true);
          await webcam.setup(); // request access to the webcam
          await webcam.play();
          console.log("Webcam started");
          window.requestAnimationFrame(loop);

          webcamElement.appendChild(webcam.canvas);
        } catch (error) {
          console.error('Error loading the model or initializing the webcam:', error);
          alert('Error: Unable to load the model or initialize webcam.');
        }
      });

      // Webcam recognition loop
      async function loop() {
        webcam.update(); // update the webcam frame
        await predict();
        window.requestAnimationFrame(loop);
      }

      // Function to predict the class of the image on the webcam
      async function predict() {
        if (!model) return;

        const prediction = await model.predict(webcam.canvas);
        document.getElementById('results-heading').innerText = `RESULTS! ${prediction[0].className}: ${prediction[0].probability.toFixed(2)}`;
      }

      // Handle 'Connect Microbit' Button
      document.getElementById('requestPortButton').addEventListener('click', async () => {
        try {
          // Request a port and open a connection to the micro:bit
          const port = await navigator.serial.requestPort();
          await port.open({ baudRate: 9600 });

          // If successful, notify the user and display the new content
          alert('Micro:bit connected successfully!');
          document.getElementById('page-1').classList.add('hide');
          document.getElementById('page-2').classList.remove('hide');

          // Request permission to access the media devices
          await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          // Populate the camera and audio dropdowns
          await populateMediaDevices();
        } catch (error) {
          // Handle user cancellation or connection errors
          console.error('There was an error connecting to the micro:bit:', error);
          alert('Failed to connect to the micro:bit. Please try again.');
        }
      });

      // Populate camera and audio dropdowns
      async function populateMediaDevices() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const videoSelect = document.getElementById('cam');
          const audioSelect = document.getElementById('aud');

          videoSelect.innerHTML = '';
          audioSelect.innerHTML = '';

          devices.forEach((device) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `Device ${device.kind}`;

            if (device.kind === 'videoinput') {
              videoSelect.appendChild(option);
            } else if (device.kind === 'audioinput') {
              audioSelect.appendChild(option);
            }
          });

          console.log("Media devices populated successfully");

          // Notify if no cameras or microphones were found
          if (videoSelect.options.length === 0) {
            const noVideoOption = document.createElement('option');
            noVideoOption.text = 'No video devices found';
            videoSelect.appendChild(noVideoOption);
          }

          if (audioSelect.options.length === 0) {
            const noAudioOption = document.createElement('option');
            noAudioOption.text = 'No audio devices found';
            audioSelect.appendChild(noAudioOption);
          }
        } catch (error) {
          console.error('Error populating media devices:', error);
          alert('Unable to access media devices. Please check permissions.');
        }
      }
    </script>
  </body>
</html>
