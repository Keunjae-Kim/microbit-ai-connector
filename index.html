<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AI Training with micro:bit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles/index.css" />
    <style>
      /* Styling for sections to control visibility */
      #page-2 {
        display: none; /* Initially hide Page 2 */
      }
      .paragraph {
        margin: 15px 0;
      }
    </style>
  </head>

  <body>
    <!-- Section representing Page 1 -->
    <div id="page-1">
      <div class="page-container">
        <h1>Connect Your micro:bit to AI</h1>
        <p>Click the button below to connect your micro:bit to your computer using WebUSB.</p>
        <button id="requestPortButton">Connect your micro:bit to your AI!</button>
        <p id="status" class="paragraph">
          Select the micro:bit in the popup screen. It might be called "mbed Serial Port."
        </p>
      </div>
    </div>

    <!-- Section representing Page 2 -->
    <div id="page-2">
      <h2>Not sure what to do?</h2>
      <p>Visit the Teachable Machine to train an AI project:</p>
      <button onclick="window.open('https://teachablemachine.withgoogle.com/', '_blank')">Google Teachable Machine</button>
      <p>
        Paste your Google Teachable Machine model link here:
        <input type="url" id="teachableUrl" placeholder="https://teachablemachine.withgoogle.com/models/[...]" required />
      </p>
      <button id="readyButton">Ready!</button>
    </div>

    <script>
const connectButton = document.getElementById("requestPortButton");
const status = document.getElementById("status");
const page1 = document.getElementById("page-1");
const page2 = document.getElementById("page-2");

// Function to handle micro:bit connection
async function connectToMicrobit() {
  try {
    status.innerText = "Attempting to connect to micro:bit...";
    console.log("Attempting to connect to micro:bit...");

    // Request device with specific vendorId for micro:bit
    const device = await navigator.usb.requestDevice({
      filters: [{ vendorId: 0x0D28 }]
    });

    status.innerText = "Device found. Attempting to open connection...";
    console.log("Device found. Attempting to open connection...");

    await device.open(); // Open the device
    console.log("Device opened.");

    if (device.configuration === null) {
      status.innerText = "Selecting configuration...";
      console.log("No configuration selected, selecting one...");
      await device.selectConfiguration(1);
    }

    status.innerText = "Claiming interface for communication...";
    console.log("Attempting to claim interface 0...");
    await device.claimInterface(0); // Claim interface for communication
    console.log("Interface claimed successfully.");

    // If everything is successful
    console.log("Micro:bit connected successfully");
    status.innerText = "Micro:bit connected successfully!";
    alert("Micro:bit connected successfully!");

    // Hide Page 1 and show Page 2
    page1.style.display = "none";
    page2.style.display = "block";

  } catch (err) {
    console.error("Error connecting to micro:bit: ", err);
    status.innerText = `Failed to connect to micro:bit. Error: ${err.message}`;
    alert("Failed to connect to micro:bit. Please check console for more details.");

    // Retry mechanism
    if (confirm("Failed to connect to micro:bit. Would you like to retry?")) {
      connectToMicrobit(); // Retry the connection process
    }
  }
}

// Attach click event to connect button
connectButton.addEventListener("click", connectToMicrobit);
    </script>
  </body>
</html>
