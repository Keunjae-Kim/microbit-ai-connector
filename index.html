<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-GV15VYJMQP"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }

      gtag('js', new Date());

      gtag('config', 'G-GV15VYJMQP');
    </script>

    <meta charset="utf-8" />
    <title>AI Training for micro:bit Projects</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Enhance your micro:bit projects with AI capabilities using this application." />

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/styles/index.css" />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Karla:ital,wght@0,400;0,700;0,800;1,400&display=swap"
      rel="stylesheet"
    />

    <!-- Jquery Styles -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"
    />
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-WF39LXQ"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div id="desktop-only">
      <h2>This Application is best used with a Desktop</h2>
    </div>

    <div id="page-1">
      <div class="page-container">
        <div class="sctn">
          <h1 class="title">MAKE: AI ROBOTS</h1>
          <br /><br />
          <p class="paragraph">
            Give your micro:bit project AI superpowers! This site will allow
            your micro:bit to use your computer's webcam to recognize images.
            You can recognize facial expressions, poses, and any object you can
            think of to put in front of your webcam! What will your micro:bit
            do when it can tell if you're smiling, or if you've deposited the
            right amount of coins?

            <br /><br />Use the links below to get your Teachable Machine image
            recognition model and your micro:bit starter code. Then click on
            the third button to connect everything together!!
          </p>

          <span class="btn-cont">
            <a
              href="https://teachablemachine.withgoogle.com/"
              target="_blank"
              id="GA-GTM-Btn-1"
              class="small-btn"
              aria-label="Google Teachable Machine AI Model"
            >
              1. Google Teachable Machine AI Model
            </a>
          </span>
          <span class="btn-cont">
            <a
              href="https://makecode.microbit.org/_Mjw1p2JsUUUE"
              target="_blank"
              id="GA-Micro-Btn-1"
              class="small-btn"
              aria-label="Starter micro:bit code"
            >
              2. Starter micro:bit code
            </a>
          </span>

          <span class="btn-container">
            <button id="requestPortButton" class="small-btn">
              3. Connect your micro:bit to your AI!
            </button>
            <p class="paragraph btn-sub">
              Select the Microbit in the popup screen. Psst, it might be called
              mbed Serial Port.
            </p>
          </span>
        </div>
        <div class="sctn img-sctn"></div>
        <a href="https://www.makershed.com/products/make-ai-robots-print">
          <img
            src="/assets/images/robot.webp"
            class="microbit-img"
            alt="Microbit AI Robot"
          />
        </a>
      </div>
    </div>

    <div id="page-2" class="hide">
      <div>
        <span class="help-section">
          <h1>Not sure what to do?</h1>
          <p>Visit the Teachable Machine to train an AI project:</p>
          <a
            href="https://teachablemachine.withgoogle.com/"
            target="_blank"
            id="GA-GTM-Btn-2"
          >
            <button class="small-btn">
              Google Teachable Machine
            </button>
          </a>
          <p>
            New to Google Teachable Machine? Follow these guidelines to learn
            more:
            <a
              class="GA-GTM"
              href="https://teachablemachine.withgoogle.com/faq"
              target="_blank"
              id="GA-GTM-Lnk-2"
              aria-label="Guide to Teachable Machine"
            >
              <em><strong>Guide to Teachable Machine</strong></em>
            </a>
          </p>
          <span class="instruction-container">
            <h2>
              When you have finished training your model, follow these 4 simple
              steps:
            </h2>
            <div class="instruction">
              <p><strong>1.</strong> Click “Export Model”</p>
              <img
                src="assets/images/TMS_1.png"
                class="tms-img"
                alt="Export Model Step"
              />
            </div>
            <div class="instruction">
              <p><strong>2.</strong> Click “Upload My Model”</p>
              <img
                src="assets/images/TMS_2.png"
                class="tms-img"
                alt="Upload My Model Step"
              />
            </div>
            <div class="instruction">
              <p><strong>3.</strong> Wait a moment</p>
              <img
                src="assets/images/TMS_3.png"
                class="tms-img"
                alt="Wait Step"
              />
            </div>
            <div class="instruction">
              <p>
                <strong>4.</strong> Click “Copy” to copy your link and paste it
                in the space above
              </p>
              <img
                src="assets/images/TMS_4.png"
                class="tms-img"
                alt="Copy Link Step"
              />
            </div>
          </span>
        </span>
        <span id="connectPort">
          <p class="sub-title">
            Paste your Google Teachable machine model link here:
          </p>
          <span class="input-container">
            <input
              id="teachableUrl"
              type="url"
              placeholder="https://teachablemachine.withgoogle.com/models/[...]"
              pattern="https://.*"
              required
              aria-label="Teachable Machine Model URL"
            />
            <span id="cam-select">
              <p>
                <label for="cam" class="choose-label">Choose Camera:</label>
                <select name="cam" id="cam"></select>
              </p>
            </span>
            <span id="aud-select">
              <p>
                <label for="aud" class="choose-label">Choose Audio:</label>
                <select name="aud" id="aud"></select>
              </p>
            </span>
            <button id="submitUrl">Ready!</button>
          </span>
        </span>
      </div>
    </div>

    <script>
      // JavaScript code to handle WebUSB connection to micro:bit and page navigation
      const connectButton = document.getElementById("requestPortButton");
      const cameraSelect = document.getElementById("cam");
      const audioSelect = document.getElementById("aud");

      async function listDevices() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            if (device.kind === 'videoinput') {
              option.text = device.label || `Camera ${cameraSelect.length + 1}`;
              cameraSelect.appendChild(option);
            } else if (device.kind === 'audioinput') {
              option.text = device.label || `Microphone ${audioSelect.length + 1}`;
              audioSelect.appendChild(option);
            }
          });
        } catch (error) {
          console.error('Error listing devices: ', error);
          alert('Failed to list devices. Please ensure permissions are granted.');
        }
      }

      connectButton.addEventListener("click", async () => {
        try {
          // Request device with specific vendorId and productId for micro:bit
          const device = await navigator.usb.requestDevice({
            filters: [
              { vendorId: 0x0d28, productId: 0x0204 }, // Adjust product ID if different
            ],
          });
          await device.open(); // Open the device
          if (device.configuration === null) {
            await device.selectConfiguration(1);
          }
          await device.claimInterface(0); // Claim interface for communication
          console.log("Micro:bit connected");

          // Proceed to the next page
          document.getElementById("page-1").classList.add("hide");
          document.getElementById("page-2").classList.remove("hide");
        } catch (err) {
          console.error("Error connecting to micro:bit: ", err);
          let errorMessage = "Failed to connect to micro:bit.";
          if (err.message.includes('Access denied')) {
            errorMessage += " Please ensure that you have granted USB permissions and try again.";
          } else if (err.message.includes('no device selected')) {
            errorMessage += " No micro:bit device was selected. Please make sure it is connected properly and try again.";
          } else if (err.message.includes('open')) {
            errorMessage += " Failed to open the device. Make sure no other application is using the micro:bit and try again.";
          } else {
            errorMessage += " Please try again.";
          }
          alert(errorMessage);
        }
      });

      // List available camera and microphone devices when the page loads
      window.addEventListener('load', listDevices);
    </script>
  </body>
</html>
