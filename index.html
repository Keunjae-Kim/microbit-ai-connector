<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-GV15VYJMQP"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }

      gtag("js", new Date());

      gtag("config", "G-GV15VYJMQP");
    </script>

    <meta charset="utf-8" />
    <title>Ai Training</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/styles/index.css" />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Karla:ital,wght@0,400;0,700;0,800;1,400&display=swap"
      rel="stylesheet"
    />

    <!-- Jquery Styles -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"
    />
  </head>

  <body>
    <div id="desktop-only">
      <h2>This Application is best used with a Desktop</h2>
    </div>

    <div id="page-1">
      <div class="page-container">
        <div class="sctn">
          <h1 class="title">MICROBIT WITH AI</h1>
          <p class="paragraph">
            Give your micro:bit project AI superpowers! Use the links below to
            get your Teachable Machine image recognition model and your
            micro:bit starter code. Then click on the third button to connect
            everything together!!
          </p>

          <span class="btn-cont">
            <a
              href="https://teachablemachine.withgoogle.com/"
              target="_blank"
              id="GA-GTM-Btn-1"
            >
              <button class="small-btn">
                1. Google Teachable Machine AI Model
              </button>
            </a>
          </span>
          <span class="btn-cont">
            <a
              href="https://makecode.microbit.org/_Mjw1p2JsUUUE"
              target="_blank"
              id="GA-Micro-Btn-1"
            >
              <button class="small-btn">2. Starter micro:bit code</button>
            </a>
          </span>

          <span class="btn-container">
            <button id="requestPortButton">
              <h1>3. Connect your micro:bit to your AI!</h1>
            </button>
            <p class="paragraph btn-sub">
              Select the Microbit in the popup screen. Psst, it might be called
              mbed Serial Port.
            </p>
          </span>
        </div>
        <div class="sctn img-sctn"></div>
        <a href="https://www.makershed.com/products/make-ai-robots-print">
          <img
            src="/assets/images/robot.webp"
            class="microbit-img"
            alt="Microbit.png"
          />
        </a>
      </div>
    </div>

    <div id="page-2" class="hide">
      <div>
        <span id="connectPort">
          <p class="sub-title">
            Paste your Google Teachable machine model link here:
          </p>
          <span class="input-container">
            <input
              id="teachableUrl"
              type="url"
              placeholder="https://teachablemachine.withgoogle.com/models/[...]"
              pattern="https://.*"
              required
            />
            <span id="cam-select">
              <p>
                <label for="cam" class="choose-label">Choose Camera:</label>
                <select name="cam" id="cam"></select>
              </p>
            </span>
            <span id="aud-select">
              <p>
                <label for="aud" class="choose-label">Choose Audio:</label>
                <select name="aud" id="aud"></select>
              </p>
            </span>
            <button id="submitUrl">Ready!</button>
          </span>
        </span>
      </div>
    </div>

    <div id="page-3" class="hide">
      <div id="overlay"></div>
      <div id="reconnectModal">
        <h1>Oops!</h1>
        <h3>
          Looks like your camera is being used already or you may have denied
          access. Check and close other applications where your camera is in
          use, then click Retry when youâ€™re ready.
        </h3>
        <div onclick="initImg(true)" id="reconnectCameraButton">Retry!</div>
      </div>
      <div class="page-container">
        <div class="display">
          <div class="display-container">
            <h1 class="projectName">Loading...</h1>
            <div class="white-bck">
              <p class="description">
                This is a Recognition Project - where the AI will be able to
                identify the classes you made based on the input you give it!
              </p>
              <div id="results" class="hide-imp">
                <span class="heading">
                  <h2 id="results-heading">RESULTS!</h2>
                </span>
                <div id="label-container"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="input-container">
          <div id="webcam-container" class="webcam-container"></div>
          <div class="webcam-container">
            <canvas id="canvas"></canvas>
          </div>
          <div id="audio-container">
            <canvas id="audioCanvas" width="400" height="400"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Socket.io -->
    <script
      src="https://cdn.socket.io/3.1.3/socket.io.min.js"
      integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
      crossorigin="anonymous"
    ></script>
    <!-- Teachable Machine: tensorflow-->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <!-- Teachable Machine: Image Recognition-->
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <!-- Jquery -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <!-- Main Scripts -->
    <script src="/index.js" type="text/javascript"></script>
    <script src="/scripts/serialConnection.js" type="text/javascript"></script>
    <script>
      document.getElementById('requestPortButton').addEventListener('click', async () => {
        try {
          // Request a port and open a connection to the micro:bit
          const port = await navigator.serial.requestPort();
          await port.open({ baudRate: 9600 });

          // If successful, notify the user and display the new content
          alert('Micro:bit connected successfully!');
          document.getElementById('page-1').style.display = 'none';
          document.getElementById('page-2').style.display = 'block';
        } catch (error) {
          console.error('There was an error connecting to the micro:bit:', error);
          alert('Failed to connect to the micro:bit. Please try again.');
        }
      });

      document.getElementById('submitUrl').addEventListener('click', async () => {
        const modelUrl = document.getElementById('teachableUrl').value;

        if (!modelUrl) {
          alert("Please provide a valid Teachable Machine model URL.");
          return;
        }

        // Attempt to load the Teachable Machine model
        try {
          const model = await tmImage.load(modelUrl + 'model.json', modelUrl + 'metadata.json');
          console.log("Model loaded successfully");

          // Hide Page 2 and show Page 3
          document.getElementById('page-2').style.display = 'none';
          document.getElementById('page-3').style.display = 'block';

          // Additional setup if needed (like starting the camera, setting up the environment)
          initModelAndCamera(model);
        } catch (error) {
          console.error("Failed to load the model: ", error);
          alert("Failed to load the model. Please ensure the link is correct.");
        }
      });

      async function initModelAndCamera(model) {
        try {
          // Initialize webcam
          const webcam = new tmImage.Webcam(200, 200, true); // width, height, flip
          await webcam.setup();
          await webcam.play();
          document.getElementById('webcam-container').appendChild(webcam.canvas);

          // Start the prediction loop
          window.requestAnimationFrame(() => predictLoop(model, webcam));
        } catch (error) {
          console.error("Error initializing the camera: ", error);
          alert("Unable to access the camera. Please check permissions.");
        }
      }

      async function predictLoop(model, webcam) {
        webcam.update(); // Update the webcam feed
        const prediction = await model.predict(webcam.canvas);
        document.getElementById("results").innerHTML = prediction
          .map(p => `<p>${p.className}: ${Math.round(p.probability * 100)}%</p>`)
          .join("");
        
        window.requestAnimationFrame(() => predictLoop(model, webcam));
      }
    </script>
  </body>
</html>
