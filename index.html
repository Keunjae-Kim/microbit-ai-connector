<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AI Training</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles/index.css" />
  </head>

  <body>
    <div id="page-1">
      <div class="page-container">
        <h1 class="title">MAKE: AI ROBOTS</h1>
        <button id="requestPortButton" class="small-btn">
          Connect your micro:bit to your AI!
        </button>
      </div>
    </div>

    <script>
      const connectButton = document.getElementById("requestPortButton");

      connectButton.addEventListener("click", async () => {
        try {
          // Request micro:bit device
          const device = await navigator.usb.requestDevice({
            filters: [{ vendorId: 0x0d28 }] // micro:bit vendor ID
          });

          await device.open(); // Open the device
          if (device.configuration === null) {
            await device.selectConfiguration(1);
          }

          // Print all available interfaces
          console.log("Available interfaces:");
          for (let i = 0; i < device.configuration.interfaces.length; i++) {
            console.log(`Interface ${i}:`, device.configuration.interfaces[i]);
          }

          // Claim the appropriate interface for serial communication
          // Typically, micro:bit uses interface 0 for serial communication
          await device.claimInterface(0); 
          console.log("Micro:bit connected to serial port");

          // Display connected message and proceed to the next page
          document.getElementById("page-1").classList.add("hide");
          alert("Successfully connected to micro:bit - mbed Serial Port");
        } catch (err) {
          console.error("Error connecting to micro:bit: ", err);
          let errorMessage = "Failed to connect to micro:bit.";
          if (err.message.includes("Access denied")) {
            errorMessage +=
              " Please ensure that you have granted USB permissions and try again.";
          } else if (err.message.includes("no device selected")) {
            errorMessage +=
              " No micro:bit device was selected. Please make sure it is connected properly and try again.";
          } else if (err.message.includes("open")) {
            errorMessage +=
              " Failed to open the device. Make sure no other application is using the micro:bit and try again.";
          } else {
            errorMessage += " Please try again.";
          }
          alert(errorMessage);
        }
      });
    </script>
  </body>
</html>
